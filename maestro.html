<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Maestro Shaol√≠n ‚Äî Turbo Master Dragon</title>
<meta name="description" content="Consejero k√°rmico para D&D: lee tu √∫ltima tirada, da consejo dh√°rmico y suena un gong al finalizar." />
<meta name="theme-color" content="#00ff7b" />
<style>
  :root{
    --green:#00ff7b; --line:#103527; --panel:#06130f; --panel2:#0a1d17; --text:#eafff5; --accent:#ffd166;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{background:#000;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;line-height:1.55;overflow-x:hidden}
  .matrix-bg{position:fixed; inset:0; z-index:-1; opacity:.16; pointer-events:none}
  .wrap{max-width:980px; margin:0 auto; padding:20px 16px}
  header.hero{margin-top:5vh; margin-bottom:18px; text-align:center; padding:18px; border:1px solid var(--line); border-radius:14px; background:var(--panel);
    box-shadow:0 0 38px rgba(0,255,150,.08), inset 0 0 22px rgba(0,255,140,.04)}
  .title{font-size:clamp(26px,4vw,40px); color:var(--green); text-shadow:0 0 10px var(--green),0 0 24px rgba(0,255,150,.35); letter-spacing:.06em; font-weight:800; margin-bottom:4px}
  .subtitle{color:#bfeee0; opacity:.95; font-size:clamp(14px,1.9vw,16px)}
  .grid{display:grid; gap:16px; grid-template-columns:1fr}
  @media(min-width:900px){ .grid{grid-template-columns: 1.1fr .9fr;} }
  .card{background:var(--panel2); border:1px solid var(--line); border-radius:14px; padding:16px}
  h2.section{color:var(--green); font-size:clamp(18px,2.4vw,22px); margin-bottom:10px; text-shadow:0 0 10px rgba(0,255,150,.25)}
  .muted{color:#cfe; opacity:.95}
  .controls{display:flex; flex-wrap:wrap; gap:10px; margin:12px 0}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; border-radius:999px; border:1px solid var(--green);
    background:linear-gradient(180deg,#02140f,#031b14); color:var(--green); text-decoration:none; font-weight:800; letter-spacing:.02em;
    box-shadow:0 0 10px var(--green), 0 0 18px rgba(0,255,140,.45); transition:transform .12s ease, box-shadow .2s ease; cursor:pointer}
  .btn:hover{ transform:translateY(-1px); box-shadow:0 0 16px var(--green), 0 0 32px rgba(0,255,140,.55) }
  .btn.alt{ border-color:var(--accent); color:var(--accent); box-shadow:0 0 10px var(--accent),0 0 18px rgba(255,209,102,.45)}
  .reading{background:rgba(0,0,0,.5); border:1px dashed var(--line); border-radius:12px; padding:14px; min-height:140px; white-space:pre-line}
  select, textarea{background:#031b14; color:#eafff5; border:1px solid var(--line); border-radius:10px; padding:10px; width:100%; font:inherit}
  .two-col{display:grid; gap:10px; grid-template-columns:1fr}
  @media(min-width:700px){ .two-col{grid-template-columns:1fr 1fr} }
  footer{margin:26px 0 20px; text-align:center; color:#9edfc9; font-size:.95rem; border-top:1px solid var(--line); padding-top:14px}
  .mini{opacity:.75; font-size:.9rem; margin-top:6px}
  #soundToggle{position:fixed; right:16px; top:16px; z-index:9999; background:#001100; color:#00ff7b; border:2px solid #00ff7b;
    border-radius:24px; padding:8px 12px; font-family:monospace; cursor:pointer; box-shadow:0 0 10px rgba(0,255,140,.35)}
  .flag{font-size:.9rem; opacity:.9}
</style>
</head>
<body>
  <!-- Fondo Matrix -->
  <canvas class="matrix-bg" id="matrixBg" aria-hidden="true"></canvas>
  <!-- Bot√≥n sonido general -->
  <button id="soundToggle" aria-pressed="false">üîá Activar sonido</button>

  <div class="wrap">
    <header class="hero">
      <div class="title">Maestro Shaol√≠n</div>
      <div class="subtitle">Consejero k√°rmico del <strong>Turbo Master Dragon‚Ñ¢</strong> para tus partidas de D&D.</div>
    </header>

    <section class="grid">
      <!-- Or√°culo -->
      <div class="card">
        <h2 class="section">üßò Lectura del Maestro</h2>
        <p class="muted">
          Al abrir esta p√°gina, el Maestro intenta leer tu <strong>√∫ltima tirada</strong> de la Calculadora K√°rmica
          (misma web, clave <code>karmicCalculator</code>). Puedes forzar una lectura con los botones.
        </p>

        <div class="controls">
          <button id="btnReadLast" class="btn">üìñ Leer √∫ltima tirada</button>
          <button id="btnRandom" class="btn alt">üé≤ Lectura aleatoria</button>
          <button id="btnToggleVoice" class="btn" aria-pressed="true">üó£Ô∏è Voz del Maestro: ON</button>
        </div>

        <div class="reading" id="readingText">El viento est√° quieto. Trae tu tirada o pide una lectura y escuchar√°s el consejo.</div>

        <div class="controls" style="margin-top:12px">
          <button id="btnSpeak" class="btn">üîÅ Repetir</button>
          <button id="btnStop"  class="btn alt">‚èπÔ∏è Parar</button>
        </div>

        <p class="muted flag" id="sourceFlag"></p>
      </div>

      <!-- Ajustes de voz -->
      <div class="card">
        <h2 class="section">üéõÔ∏è Voz y estilo</h2>
        <div class="two-col">
          <div>
            <label for="voiceSelect" class="muted">Voz</label>
            <select id="voiceSelect" aria-label="Seleccionar voz"></select>
          </div>
          <div>
            <label for="manualJson" class="muted">(Opcional) Pegar JSON de tirada</label>
            <textarea id="manualJson" rows="6" placeholder='{"type":"dharma","result":"INMUNIDAD por 1 turno"}'></textarea>
          </div>
        </div>
      </div>
    </section>

    <footer>
      ¬© 2025 Constantino y Federico Garc√≠a ‚Äî <em>Curvism instead cubism‚Ñ¢</em>. Todos los derechos redondeados con reserva.
      <div class="mini">Turbo Master Dragon‚Ñ¢ ¬∑ Maestro Shaol√≠n (v2).</div>
    </footer>
  </div>

  <!-- Audios -->
  <audio id="ambientAudio" src="https://federicogarcia.art/wp-content/uploads/2025/10/china-green-tea-380502.mp3" loop preload="auto" playsinline></audio>
  <audio id="gongAudio"    src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_3b6a6c9e61.mp3?filename=gong-hit-105527.mp3" preload="auto" playsinline></audio>

<script>
/* ===== Fondo Matrix ===== */
(function(){
  const c=document.getElementById('matrixBg'),x=c.getContext('2d');
  function resize(){ c.width=innerWidth; c.height=innerHeight; }
  resize(); addEventListener('resize',resize);
  const chars='„Ç¢„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É©„ÉØ0123456789‚òØKARMADHARMANIDANAS';
  const A=chars.split(''); const fs=14; let cols=Math.floor(c.width/fs);
  let drops=Array(cols).fill(1);
  setInterval(function(){
    if(cols!==Math.floor(c.width/fs)){ cols=Math.floor(c.width/fs); drops=Array(cols).fill(1); }
    x.fillStyle='rgba(0,0,0,0.06)'; x.fillRect(0,0,c.width,c.height);
    x.fillStyle='#00ff7b'; x.font=fs+'px monospace';
    for(let i=0;i<drops.length;i++){
      const t=A[(Math.random()*A.length)|0];
      x.fillText(t,i*fs,drops[i]*fs);
      if(drops[i]*fs>c.height && Math.random()>0.975) drops[i]=0;
      drops[i]++;
    }
  },33);
})();

/* ===== Audio global (autoplay con primer toque) ===== */
(function(){
  const ambient = document.getElementById("ambientAudio");
  const toggle  = document.getElementById("soundToggle");
  let audioReady = false;

  function tryPlayAmbient(){
    if (!ambient) return;
    ambient.volume = 0.45;
    ambient.play().then(()=>{
      audioReady = true;
      if (toggle){ toggle.textContent = "üîä Silenciar"; toggle.setAttribute("aria-pressed","true"); }
    }).catch(()=>{});
  }
  function onFirst(){ tryPlayAmbient(); window.removeEventListener("pointerdown", onFirst); }
  window.addEventListener("pointerdown", onFirst, {once:true});
  if (toggle){
    toggle.addEventListener("click", ()=>{
      if (!audioReady){ tryPlayAmbient(); return; }
      if (ambient.paused){ ambient.play(); toggle.textContent="üîä Silenciar"; toggle.setAttribute("aria-pressed","true"); }
      else { ambient.pause(); toggle.textContent="üîá Activar sonido"; toggle.setAttribute("aria-pressed","false"); }
    });
  }
  window._audio_ready = ()=>audioReady;
})();

/* ===== Dataset m√≠nimo por si no hay calculadora ===== */
const FALLBACK_KARMA = [
  {type:"karma",   result:"AUTOGOL: Retrocede 3 espacios"},
  {type:"karma",   result:"P√âRDIDA DE TURNO por arrogancia espiritual"},
  {type:"dharma",  result:"AVANCE R√ÅPIDO: +4 espacios"},
  {type:"dharma",  result:"INMUNIDAD K√ÅRMICA por 1 turno"},
  {type:"dharma",  result:"DOBLE MOVIMIENTO en tu siguiente ronda"}
];

/* ===== Helpers: √∫ltima tirada de la calculadora ===== */
function getLastKarmicFromLocalStorage(){
  try{
    const raw = localStorage.getItem("karmicCalculator");
    if (!raw) return null;
    const data = JSON.parse(raw);
    const hist = Array.isArray(data.history)? data.history : [];
    if (!hist.length) return null;
    const last = hist[0];

    // Ruletas modernas
    if (last.from === 'roulette' && last.fullData?.result){
      return { type: last.to, result: last.fullData.result };
    }
    // Texto plano
    if (last.description && (last.description.startsWith("KARMA") || last.description.startsWith("DHARMA"))){
      const [kind, ...rest] = last.description.split(":");
      return { type: kind.toLowerCase(), result: rest.join(":").trim() };
    }
    // Interacci√≥n de reinos
    if (last.fullData?.difficulty !== undefined){
      const desc = last.description || "";
      const parts = desc.split("‚Üí");
      const from = (parts[0]||"Humano").trim();
      const to = (parts[1]||"Humano").split(":")[0].trim();
      return { type:"interaction", result:`Interacci√≥n ${from} ‚Üí ${to} (dif. ${last.fullData.difficulty})` };
    }
  }catch(e){}
  return null;
}

/* ===== Forja del mensaje (tono Shaol√≠n) ===== */
function forgeShaolinReading(payload){
  const intros = [
    "El bamb√∫ se inclina, pero no se quiebra.",
    "Respira hondo. Observa sin juicio.",
    "Cuando la mente se aquieta, el camino aparece.",
    "Quien empuja el r√≠o, solo se cansa."
  ];
  const outro = [
    "Camina suave. La salida est√° en tu siguiente decisi√≥n.",
    "Suelta un poco hoy, para andar m√°s lejos ma√±ana.",
    "El dado cae, pero tu intenci√≥n lo gu√≠a.",
    "Mira la luna y recuerda: no eres tus sombras."
  ];
  let cuerpo = "";
  if (payload?.type === "karma"){
    cuerpo = `Veo carga activa: ${payload.result}. No luches contra el golpe; absorbe y redirige. Practica una renuncia peque√±a ahora.`;
  } else if (payload?.type === "dharma"){
    cuerpo = `Llega viento propicio: ${payload.result}. √ösalo para levantar tambi√©n a otro. Compartir te har√° m√°s ligero.`;
  } else if (payload?.type === "interaction"){
    cuerpo = `Cruce entre fuerzas: ${payload.result}. Observa el apego que empuja. Si puedes, escoge la opci√≥n con menos orgullo.`;
  } else {
    const rnd = FALLBACK_KARMA[(Math.random()*FALLBACK_KARMA.length)|0];
    cuerpo = `Sin se√±ales recientes, leo el pulso: ${rnd.type.toUpperCase()} ‚Äî ${rnd.result}. Toma el siguiente paso con humildad.`;
  }
  const t = `${intros[(Math.random()*intros.length)|0]}\n${cuerpo}\n${outro[(Math.random()*outro.length)|0]}`;
  return t;
}

/* ===== SpeechSynthesis ===== */
const voiceSelect = document.getElementById("voiceSelect");
let voices = [], currentVoice = null, voiceOn = true;

function populateVoices(){
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  const esVoices = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith("es"));
  const list = esVoices.length ? esVoices : voices;
  list.forEach((v)=>{
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} ‚Äî ${v.lang}`;
    voiceSelect.appendChild(opt);
  });
  currentVoice = list[0] || voices[0] || null;
}
if ('speechSynthesis' in window){
  populateVoices();
  window.speechSynthesis.onvoiceschanged = populateVoices;
}

function speakText(text){
  if (!voiceOn || !('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  if (currentVoice) u.voice = voices.find(v => v.name === currentVoice.name) || currentVoice;
  u.lang = (u.voice && u.voice.lang) ? u.voice.lang : "es-ES";
  u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;

  // Al terminar: gong
  const gong = document.getElementById("gongAudio");
  u.onend = ()=>{ if (gong){ try{ gong.currentTime=0; gong.volume=0.6; gong.play().catch(()=>{});}catch(_){} } };

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ===== UI ===== */
const readingEl   = document.getElementById("readingText");
const btnReadLast = document.getElementById("btnReadLast");
const btnRandom   = document.getElementById("btnRandom");
const btnSpeak    = document.getElementById("btnSpeak");
const btnStop     = document.getElementById("btnStop");
const btnToggle   = document.getElementById("btnToggleVoice");
const manualJson  = document.getElementById("manualJson");
const sourceFlag  = document.getElementById("sourceFlag");

voiceSelect.addEventListener("change", ()=>{
  const v = voices.find(v => v.name === voiceSelect.value);
  if (v) currentVoice = v;
});

btnToggle.addEventListener("click", ()=>{
  voiceOn = !voiceOn;
  btnToggle.textContent = voiceOn ? "üó£Ô∏è Voz del Maestro: ON" : "ü§´ Voz del Maestro: OFF";
  btnToggle.setAttribute("aria-pressed", voiceOn ? "true" : "false");
});

btnReadLast.addEventListener("click", ()=>{
  const manual = manualJson.value.trim();
  let payload = null, source = "";
  if (manual){
    try { payload = JSON.parse(manual); source="Fuente: JSON pegado manualmente.";} catch(_){}
  }
  if (!payload){ payload = getLastKarmicFromLocalStorage(); source = payload ? "Fuente: Calculadora (localStorage)." : ""; }
  if (!payload){ payload = FALLBACK_KARMA[(Math.random()*FALLBACK_KARMA.length)|0]; source = "Fuente: Plantilla de respaldo."; }

  const txt = forgeShaolinReading(payload);
  readingEl.textContent = txt;
  sourceFlag.textContent = source;
  speakText(txt);
});

btnRandom.addEventListener("click", ()=>{
  const payload = FALLBACK_KARMA[(Math.random()*FALLBACK_KARMA.length)|0];
  const txt = forgeShaolinReading(payload);
  readingEl.textContent = txt;
  sourceFlag.textContent = "Fuente: Aleatoria (fallback).";
  speakText(txt);
});

btnSpeak.addEventListener("click", ()=>{
  const txt = readingEl.textContent.trim();
  if (txt) speakText(txt);
});

btnStop.addEventListener("click", ()=>{
  if ('speechSynthesis' in window) speechSynthesis.cancel();
});

/* ===== Autolectura al entrar (prioridad: JSON pegado > localStorage > fallback) ===== */
window.addEventListener("DOMContentLoaded", ()=>{
  // intenta JSON manual
  let payload = null, source = "";
  const manual = manualJson.value.trim();
  if (manual){
    try { payload = JSON.parse(manual); source = "Fuente: JSON pegado manualmente."; } catch(_){}
  }
  // si no, localStorage
  if (!payload){
    payload = getLastKarmicFromLocalStorage();
    if (payload) source = "Fuente: Calculadora (localStorage).";
  }
  // si nada, muestra mensaje neutro (no habla hasta que pulses)
  if (payload){
    const txt = forgeShaolinReading(payload);
    readingEl.textContent = txt;
    sourceFlag.textContent = source;
    // auto-speak (si la voz est√° ON)
    speakText(txt);
  } else {
    readingEl.textContent = "No encuentro una tirada reciente. Pulsa ‚Äúüìñ Leer √∫ltima tirada‚Äù o ‚Äúüé≤ Lectura aleatoria‚Äù.";
    sourceFlag.textContent = "";
  }
});
<script>
async function cargarFrase(evento, meta={}) {
  const res = await fetch('archivoshaolin.json');
  const data = await res.json();

  // 1) 50% plantilla generativa, 50% frase cerrada
  const useTemplate = Math.random() < 0.5 && data.plantillas && data.diccionarios;
  let texto;

  if (useTemplate) {
    const T = data.plantillas[Math.floor(Math.random() * data.plantillas.length)];
    texto = T.replace(/\{(\w+)\}/g, (_, k) => {
      if (k in meta) return meta[k]; // {from},{to},{dif},{evento}
      const bag = data.diccionarios[k];
      return bag ? bag[Math.floor(Math.random() * bag.length)] : `{${k}}`;
    });
  } else {
    const pool = evento ? data.frases.filter(f => f.cuando === evento) : data.frases;
    const pick = pool.length ? pool : data.frases;
    texto = pick[Math.floor(Math.random() * pick.length)].frase;
    // post-procesa placeholders si los hay
    texto = texto.replace(/\{(\w+)\}/g, (_, k) => meta[k] ?? `{${k}}`);
  }

  return texto;
}

// === Panel de efectos Shaolin ===
(function(){
  const efectosShaolin = [
    "alone-samurai-in-mountain-430719.mp3",
    "asiatic-intro_3-283719.mp3",
    "birds-chirping-67827.mp3",
    "China-cymbal-transition-sound-effect.mp3",
    "chinese-beat-190047.mp3",
    "chinese-flute-hulusi-76116.mp3",
    "chinese-ident-transition-1-283708.mp3",
    "CHINITO COLTICO.mp3",
    "dizi-flute-02-72563.mp3",
    "fireworks-07-419025.mp3",
    "Gong-sound.mp3",
    "gongfeb11-91065.mp3",
    "INTROCHINO.mp3",
    "music-transition-ancient-back-etlx-247347.mp3",
    "spike-one-31462.mp3",
    "tibetan-buddhist-drum-314994.mp3"
  ];

  const btn = document.createElement("button");
  btn.textContent = "üéõÔ∏è Efecto Shaolin";
  btn.style.position = "fixed";
  btn.style.left = "16px";
  btn.style.bottom = "16px";
  btn.style.background = "#031b14";
  btn.style.border = "2px solid #00ff7b";
  btn.style.borderRadius = "999px";
  btn.style.color = "#00ff7b";
  btn.style.fontWeight = "bold";
  btn.style.padding = "10px 18px";
  btn.style.cursor = "pointer";
  btn.style.boxShadow = "0 0 15px rgba(0,255,150,.4)";
  document.body.appendChild(btn);

  btn.addEventListener("click", ()=>{
    const aleatorio = efectosShaolin[Math.floor(Math.random()*efectosShaolin.length)];
    const audio = new Audio(`audio/shaolin/${aleatorio}`);
    audio.volume = 0.8;
    audio.play().catch(()=>{});
  });
})();
</script><!-- === Panel de Efectos Shaolin === -->
<script>
(function(){
  const efectosShaolin = [
    "alone-samurai-in-mountain-430719.mp3",
    "asiatic-intro_3-283719.mp3",
    "birds-chirping-67827.mp3",
    "China-cymbal-transition-sound-effect.mp3",
    "chinese-beat-190047.mp3",
    "chinese-flute-hulusi-76116.mp3",
    "chinese-ident-transition-1-283708.mp3",
    "CHINITO COLTICO.mp3",
    "dizi-flute-02-72563.mp3",
    "fireworks-07-419025.mp3",
    "Gong-sound.mp3",
    "gongfeb11-91065.mp3",
    "INTROCHINO.mp3",
    "music-transition-ancient-back-etlx-247347.mp3",
    "spike-one-31462.mp3",
    "tibetan-buddhist-drum-314994.mp3"
  ];

  const btn = document.createElement("button");
  btn.textContent = "üéõÔ∏è Efecto Shaolin";
  Object.assign(btn.style, {
    position:"fixed", left:"16px", bottom:"16px", zIndex:9999,
    background:"#031b14", border:"2px solid #00ff7b",
    borderRadius:"999px", color:"#00ff7b",
    fontWeight:"bold", padding:"10px 18px",
    cursor:"pointer", boxShadow:"0 0 15px rgba(0,255,150,.4)"
  });
  document.body.appendChild(btn);

  btn.addEventListener("click", ()=>{
    const aleatorio = efectosShaolin[Math.floor(Math.random()*efectosShaolin.length)];
    const audio = new Audio(`audio/shaolin/${aleatorio}`);
    audio.volume = 0.8;
    audio.play().catch(()=>{});
  });
})();
</script>