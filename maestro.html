<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Maestro Shaol√≠n ‚Äî Turbo Master Dragon</title>
<meta name="description" content="Consejero k√°rmico para D&D: lecturas del Maestro, ambiente Shaol√≠n y efectos especiales sin complicaciones." />
<meta name="theme-color" content="#00ff7b" />
<style>
  :root{
    --green:#00ff7b; --accent:#ffd166; --line:#103527;
    --panel:#06130f; --panel2:#0a1d17; --text:#eafff5;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:#000;color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    line-height:1.55; overflow-x:hidden;
  }
  .matrix-bg{position:fixed; inset:0; z-index:-1; opacity:.14; pointer-events:none}

  .wrap{max-width:980px; margin:0 auto; padding:20px 16px}
  header.hero{
    margin-top:5vh; margin-bottom:18px; text-align:center;
    padding:18px; border:1px solid var(--line); border-radius:14px; background:var(--panel);
    box-shadow:0 0 38px rgba(0,255,150,.08), inset 0 0 22px rgba(0,255,140,.04)
  }
  .title{font-size:clamp(26px,4vw,40px); color:var(--green); font-weight:800; letter-spacing:.04em; margin-bottom:4px; text-shadow:0 0 10px rgba(0,255,150,.35)}
  .subtitle{color:#bfeee0; opacity:.95; font-size:clamp(14px,1.9vw,16px)}

  .grid{display:grid; gap:16px; grid-template-columns:1fr}
  @media(min-width:900px){ .grid{grid-template-columns: 1.1fr .9fr;} }
  .card{background:var(--panel2); border:1px solid var(--line); border-radius:14px; padding:16px}
  h2.section{color:var(--green); font-size:clamp(18px,2.4vw,22px); margin-bottom:10px; text-shadow:0 0 10px rgba(0,255,150,.25)}
  .muted{color:#cfe; opacity:.95}

  .controls{display:flex; flex-wrap:wrap; gap:10px; margin:12px 0}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:999px; border:1px solid var(--green);
    background:linear-gradient(180deg,#02140f,#031b14);
    color:var(--green); text-decoration:none; font-weight:800; letter-spacing:.02em;
    box-shadow:0 0 10px var(--green), 0 0 18px rgba(0,255,140,.45);
    transition:transform .12s ease, box-shadow .2s ease; cursor:pointer
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 0 16px var(--green), 0 0 32px rgba(0,255,140,.55) }
  .btn.alt{ border-color:var(--accent); color:var(--accent); box-shadow:0 0 10px var(--accent),0 0 18px rgba(255,209,102,.45) }
  .btn.warn{ border-color:#ff6b6b; color:#ff6b6b; box-shadow:0 0 10px #ff6b6b,0 0 18px rgba(255,107,107,.45) }

  .reading{background:rgba(0,0,0,.5); border:1px dashed var(--line); border-radius:12px; padding:14px; min-height:140px; white-space:pre-line}

  .col{display:flex; flex-direction:column; gap:10px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .slider{width:180px}
  select{
    width:100%; padding:10px; border-radius:10px; border:1px solid var(--line);
    background:#031b14; color:#eafff5; font:inherit;
  }

  footer{margin:26px 0 20px; text-align:center; color:#9edfc9; font-size:.95rem; border-top:1px solid var(--line); padding-top:14px}
  .mini{opacity:.75; font-size:.9rem; margin-top:6px}
</style>
</head>
<body>
  <canvas class="matrix-bg" id="matrixBg" aria-hidden="true"></canvas>

  <div class="wrap">
    <header class="hero">
      <div class="title">Maestro Shaol√≠n</div>
      <div class="subtitle">Consejero k√°rmico del <strong>Turbo Master Dragon‚Ñ¢</strong> para tus partidas de D&D.</div>
    </header>

    <!-- Bloque de ambiente y SFX -->
    <div class="card">
      <h2 class="section">üåø Ambiente Shaol√≠n & SFX</h2>
      <p class="muted">Ambient = base musical larga (en bucle). SFX = toques cortos que puedes superponer para dramatizar.</p>
      <div class="controls">
        <button id="btnAmbient" class="btn">üåø Ambient: ‚ñ∂ Iniciar</button>
        <button id="btnSfx" class="btn alt">üé≤ SFX aleatorio</button>
        <button id="btnStopAll" class="btn warn">‚èπÔ∏è Parar todo</button>
        <label class="row" style="gap:8px;margin-left:auto">
          Volumen <input id="vol" class="slider" type="range" min="0" max="1" step="0.01" value="0.5" />
        </label>
        <label class="row" style="gap:8px">
          <input id="duck" type="checkbox" checked /> Atenuar m√∫sica al hablar
        </label>
      </div>
      <p class="muted">Consejo DM: activa el Ambient al empezar la sesi√≥n y dispara SFX en momentos clave.</p>
    </div>

    <section class="grid">
      <!-- Lectura del Maestro -->
      <div class="card">
        <h2 class="section">üßò Lectura del Maestro</h2>
        <p class="muted">
          Pulsa para que el Maestro lea tu <strong>√∫ltima tirada</strong> de la Calculadora (misma web, clave <code>karmicCalculator</code>)
          o genere una lectura ritual.
        </p>
        <div class="controls">
          <button id="btnReadLast" class="btn">üìñ Leer √∫ltima tirada</button>
          <button id="btnRandom" class="btn alt">üé≤ Lectura aleatoria</button>
          <button id="btnToggleVoice" class="btn" aria-pressed="true">üó£Ô∏è Voz del Maestro: ON</button>
        </div>
        <div id="readingText" class="reading">El viento est√° quieto. Trae tu tirada o pide una lectura y escuchar√°s el consejo.</div>
        <div class="controls">
          <button id="btnRepeat" class="btn">üîÅ Repetir</button>
          <button id="btnStopTTS" class="btn warn">‚èπÔ∏è Parar voz</button>
        </div>
      </div>

      <!-- Voz (simple) -->
      <div class="card col">
        <h2 class="section">üéõÔ∏è Voz</h2>
        <label class="muted">Selecciona la voz del Maestro</label>
        <select id="voiceSelect"></select>
        <p class="muted">Tip: usa <strong>Shaol√≠n Pro+</strong> (Ambient + SFX) para dar ambiente musical. La voz aten√∫a la m√∫sica y luego vuelve a subir.</p>
      </div>
    </section>

    <footer>
      ¬© 2025 Constantino y Federico Garc√≠a ‚Äî <em>Curvism instead cubism‚Ñ¢</em>. Todos los derechos redondeados con reserva.
      <div class="mini">Turbo Master Dragon‚Ñ¢ ¬∑ Maestro Shaol√≠n (v6).</div>
    </footer>
  </div>

<script>
/* ===== Fondo Matrix (ligero) ===== */
(function(){
  const c=document.getElementById('matrixBg'),x=c.getContext('2d');
  function R(){ c.width=innerWidth; c.height=innerHeight; }
  R(); addEventListener('resize',R);
  const A='„Ç¢„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É©„ÉØ0123456789‚òØKARMA DHARMA'.split(''), fs=14;
  let cols=Math.floor(c.width/fs), drops=Array(cols).fill(1);
  setInterval(()=>{
    if(cols!==Math.floor(c.width/fs)){ cols=Math.floor(c.width/fs); drops=Array(cols).fill(1); }
    x.fillStyle='rgba(0,0,0,0.06)'; x.fillRect(0,0,c.width,c.height);
    x.fillStyle='#00ff7b'; x.font=fs+'px monospace';
    for(let i=0;i<drops.length;i++){
      x.fillText(A[(Math.random()*A.length)|0],i*fs,drops[i]*fs);
      if(drops[i]*fs>c.height && Math.random()>0.975) drops[i]=0;
      drops[i]++;
    }
  },33);
})();

/* ===== Estado global simple ===== */
const state = {
  ambient:null,
  ambientOn:false,
  ambientPlaylist:[
    // usa tus audios largos; puedes a√±adir m√°s archivos aqu√≠
    "chinese-beat-190047.mp3",
    "music-transition-ancient-back-etlx-247347.mp3"
  ],
  sfxList:[
    "alone-samurai-in-mountain-430719.mp3",
    "asiatic-intro_3-283719.mp3",
    "birds-chirping-67827.mp3",
    "China-cymbal-transition-sound-effect.mp3",
    "chinese-flute-hulusi-76116.mp3",
    "chinese-ident-transition-1-283708.mp3",
    "dizi-flute-02-72563.mp3",
    "fireworks-07-419025.mp3",
    "Gong-sound.mp3",
    "gongfeb11-91065.mp3",
    "INTROCHINO.mp3",
    "spike-one-31462.mp3",
    "tibetan-buddhist-drum-314994.mp3"
  ],
  activeSfx:[],
  voiceOn:true,
  voices:[],
  currentVoice:null
};

/* ===== Utilidades ===== */
function byId(id){ return document.getElementById(id); }
function pick(arr){ return arr[(Math.random()*arr.length)|0]; }

/* ===== Audio: Ambient & SFX ===== */
function ensureAmbient(){
  if (state.ambient) return state.ambient;
  const a = new Audio(`audio/shaolin/${pick(state.ambientPlaylist)}`);
  a.loop = true;
  a.volume = parseFloat(byId('vol').value || '0.5');
  a.onended = ()=>{ /* con loop=true no llega aqu√≠ */ };
  state.ambient = a;
  return a;
}
function toggleAmbient(){
  const btn = byId('btnAmbient');
  const a = ensureAmbient();
  if (!state.ambientOn){
    a.play().catch(()=>{});
    state.ambientOn = true;
    btn.textContent = "üåø Ambient: ‚è∏Ô∏è Pausar";
  } else {
    a.pause();
    state.ambientOn = false;
    btn.textContent = "üåø Ambient: ‚ñ∂ Iniciar";
  }
}
function playSfx(){
  const file = pick(state.sfxList);
  const a = new Audio(`audio/shaolin/${file}`);
  a.volume = parseFloat(byId('vol').value || '0.5');
  state.activeSfx.push(a);
  a.onended = ()=>{ state.activeSfx = state.activeSfx.filter(x=>x!==a); };
  a.play().catch(()=>{});
}
function stopAllAudio(){
  if (state.ambient){ state.ambient.pause(); state.ambient.currentTime = 0; state.ambientOn = false; byId('btnAmbient').textContent="üåø Ambient: ‚ñ∂ Iniciar"; }
  state.activeSfx.forEach(a=>{ try{ a.pause(); a.currentTime=0; }catch(_){ } });
  state.activeSfx = [];
}

/* ===== Lecturas del Maestro ===== */
const FALLBACK_KARMA = [
  {type:"karma",   result:"AUTOGOL: Retrocede 3 espacios"},
  {type:"karma",   result:"P√âRDIDA DE TURNO por arrogancia espiritual"},
  {type:"dharma",  result:"AVANCE R√ÅPIDO: +4 espacios"},
  {type:"dharma",  result:"INMUNIDAD K√ÅRMICA por 1 turno"},
  {type:"dharma",  result:"DOBLE MOVIMIENTO en tu siguiente ronda"}
];

function getLastFromLocalStorage(){
  try{
    const raw = localStorage.getItem("karmicCalculator");
    if (!raw) return null;
    const data = JSON.parse(raw);
    const hist = Array.isArray(data.history)? data.history : [];
    if (!hist.length) return null;
    const last = hist[0];
    if (last.from === 'roulette' && last.fullData?.result){
      return { type: last.to, result: last.fullData.result };
    }
    if (last.description && (last.description.startsWith("KARMA")||last.description.startsWith("DHARMA"))){
      const [kind, ...rest] = last.description.split(":");
      return { type: kind.toLowerCase(), result: rest.join(":").trim() };
    }
    if (last.fullData?.difficulty !== undefined){
      const desc = last.description || "";
      const parts = desc.split("‚Üí");
      const from = (parts[0]||"Humano").trim();
      const to = (parts[1]||"Humano").split(":")[0].trim();
      return { type:"interaction", result:`Interacci√≥n ${from} ‚Üí ${to} (dif. ${last.fullData.difficulty})` };
    }
  }catch(e){}
  return null;
}

function forgeReading(payload){
  const intro = pick([
    "El bamb√∫ se inclina, pero no se quiebra.",
    "Respira hondo. Observa sin juicio.",
    "Cuando la mente se aquieta, el camino aparece.",
    "Quien empuja el r√≠o, solo se cansa."
  ]);
  let cuerpo = "";
  if (payload?.type === "karma"){
    cuerpo = `Veo carga activa: ${payload.result}. No luches contra el golpe; absorbe y redirige. Practica una renuncia peque√±a ahora.`;
  } else if (payload?.type === "dharma"){
    cuerpo = `Llega viento propicio: ${payload.result}. √ösalo para levantar tambi√©n a otro. Compartir te har√° m√°s ligero.`;
  } else if (payload?.type === "interaction"){
    cuerpo = `Cruce entre fuerzas: ${payload.result}. Observa el apego que empuja. Si puedes, escoge la opci√≥n con menos orgullo.`;
  } else {
    const rnd = pick(FALLBACK_KARMA);
    cuerpo = `Sin se√±ales recientes, leo el pulso: ${rnd.type.toUpperCase()} ‚Äî ${rnd.result}. Toma el siguiente paso con humildad.`;
  }
  const outro = pick([
    "Camina suave. La salida est√° en tu siguiente decisi√≥n.",
    "Suelta un poco hoy, para andar m√°s lejos ma√±ana.",
    "El dado cae, pero tu intenci√≥n lo gu√≠a.",
    "Mira la luna y recuerda: no eres tus sombras."
  ]);
  return `${intro}\n${cuerpo}\n${outro}`;
}

/* ===== Voz (SpeechSynthesis) con ducking ===== */
function populateVoices(){
  state.voices = speechSynthesis.getVoices();
  const es = state.voices.filter(v => v.lang?.toLowerCase().startsWith("es"));
  const list = es.length ? es : state.voices;
  const sel = byId('voiceSelect');
  sel.innerHTML = "";
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value = v.name; o.textContent = `${v.name} ‚Äî ${v.lang}`;
    sel.appendChild(o);
  });
  state.currentVoice = list[0] || null;
}

function speak(text){
  if (!state.voiceOn || !('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  if (state.currentVoice){
    const v = state.voices.find(x=>x.name===state.currentVoice.name) || state.currentVoice;
    u.voice = v;
    u.lang  = v.lang || "es-ES";
  } else {
    u.lang = "es-ES";
  }
  u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;

  // Ducking
  const a = state.ambient;
  const duck = byId('duck').checked;
  let prevVol = a ? a.volume : 0;
  u.onstart = ()=>{
    if (duck && a && !a.paused){
      prevVol = a.volume;
      a.volume = Math.max(0, prevVol * 0.25);
    }
  };
  u.onend = ()=>{
    if (duck && a){ a.volume = prevVol; }
  };

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ===== Wire UI una sola vez ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Botones ambiente/SFX
  byId('btnAmbient').onclick = toggleAmbient;
  byId('btnSfx').onclick = playSfx;
  byId('btnStopAll').onclick = ()=>{
    stopAllAudio();
    if ('speechSynthesis' in window) speechSynthesis.cancel();
  };
  byId('vol').oninput = (e)=>{
    const v = parseFloat(e.target.value);
    if (state.ambient) state.ambient.volume = v;
  };

  // Voz
  if ('speechSynthesis' in window){
    populateVoices();
    window.speechSynthesis.onvoiceschanged = populateVoices;
  }
  byId('voiceSelect').onchange = (e)=>{
    const name = e.target.value;
    const v = state.voices.find(x=>x.name===name);
    if (v) state.currentVoice = v;
  };
  byId('btnToggleVoice').onclick = (e)=>{
    state.voiceOn = !state.voiceOn;
    e.currentTarget.textContent = state.voiceOn ? "üó£Ô∏è Voz del Maestro: ON" : "ü§´ Voz del Maestro: OFF";
    e.currentTarget.setAttribute("aria-pressed", state.voiceOn ? "true" : "false");
  };

  // Lecturas
  const out = byId('readingText');
  byId('btnReadLast').onclick = ()=>{
    const p = getLastFromLocalStorage() || pick(FALLBACK_KARMA);
    const t = forgeReading(p);
    out.textContent = t;
    speak(t);
  };
  byId('btnRandom').onclick = ()=>{
    const p = pick(FALLBACK_KARMA);
    const t = forgeReading(p);
    out.textContent = t;
    speak(t);
  };
  byId('btnRepeat').onclick = ()=>{
    const t = out.textContent.trim();
    if (t) speak(t);
  };
  byId('btnStopTTS').onclick = ()=>{
    if ('speechSynthesis' in window) speechSynthesis.cancel();
  };
});
</script>
</body>
</html>