<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DM Panel PRO ‚Äî Turbo Master Dragon‚Ñ¢</title>
<meta name="theme-color" content="#00ff7b" />
<meta name="description" content="Panel para Dungeon Masters: Maestro Shaol√≠n con lectura k√°rmica, ambiente musical, SFX y modal Shaol√≠n Pro+." />
<style>
  :root{
    --green:#00ff7b; --accent:#ffd166; --line:#113c2d;
    --panel:#06130f; --panel2:#0a1d17; --text:#eafff5;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:#000; color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    line-height:1.55; overflow-x:hidden;
  }
  .matrix-bg{position:fixed; inset:0; z-index:-1; opacity:.12; pointer-events:none}
  .wrap{max-width:1100px; margin:0 auto; padding:20px 14px}

  /* Hero / Promo */
  .promo{
    background:radial-gradient(1100px 520px at 50% 0%, #042218 0%, #000 72%);
    border-bottom:1px solid #0a3; padding:28px 14px 22px; text-align:center;
    box-shadow:inset 0 0 40px rgba(0,255,150,.12);
  }
  .title{
    font-size:clamp(24px,4.4vw,40px); font-weight:900; letter-spacing:.04em;
    color:var(--green); text-shadow:0 0 16px rgba(0,255,150,.6);
  }
  .subtitle{color:#cfe; opacity:.95; margin-top:6px}
  .cta{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:12px 16px; border-radius:999px; border:1px solid var(--green);
    background:linear-gradient(180deg,#02140f,#031b14); color:var(--green); text-decoration:none;
    font-weight:800; letter-spacing:.02em; cursor:pointer;
    box-shadow:0 0 10px var(--green),0 0 18px rgba(0,255,140,.45);
    transition:transform .12s ease, box-shadow .2s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 0 16px var(--green),0 0 32px rgba(0,255,140,.55) }
  .btn.alt{ border-color:var(--accent); color:var(--accent);
    box-shadow:0 0 10px var(--accent),0 0 18px rgba(255,209,102,.45) }

  /* Grid principal */
  .grid{display:grid; gap:14px; grid-template-columns:1fr}
  @media(min-width:900px){ .grid{grid-template-columns:1.2fr .8fr} }
  .card{background:var(--panel2); border:1px solid var(--line); border-radius:14px; padding:14px}
  h2.section{color:var(--green); font-size:clamp(18px,2.2vw,22px); margin-bottom:8px; text-shadow:0 0 10px rgba(0,255,150,.25)}
  .muted{color:#cfe; opacity:.95}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .stack{display:grid; gap:10px}
  .reading{
    background:rgba(0,0,0,.5); border:1px dashed var(--line); border-radius:12px;
    padding:12px; min-height:120px; white-space:pre-line
  }
  select, input[type="text"], textarea{
    background:#031b14; color:#eafff5; border:1px solid var(--line); border-radius:10px;
    padding:10px; width:100%; font:inherit;
  }
  .controls{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0}
  .small{font-size:.92rem; opacity:.92}

  /* Modal Shaolin Pro+ */
  dialog#sfxModal{
    width:min(720px,92vw); background:#041510; border:1px solid var(--line); border-radius:16px; color:var(--text);
    box-shadow:0 10px 40px rgba(0,0,0,.6), 0 0 32px rgba(0,255,150,.15);
  }
  dialog::backdrop{ background:rgba(0,0,0,.6) }
  .modal-hdr{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line)}
  .modal-grid{display:grid; gap:10px; grid-template-columns:1fr 1fr}
  @media(max-width:640px){ .modal-grid{grid-template-columns:1fr} }
  .sfx-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--line); border-radius:10px; background:#071c16}
  .x{background:transparent; border:1px solid var(--line); color:#9edfc9; padding:8px 10px; border-radius:10px; cursor:pointer}

  /* Footer */
  footer{margin:24px 0 18px; text-align:center; color:#9edfc9; font-size:.95rem; border-top:1px solid var(--line); padding-top:12px}
  .mini{opacity:.75; font-size:.9rem; margin-top:6px}

  /* Flotante de sonido general */
  #soundToggle{
    position:fixed; right:14px; top:14px; z-index:9999;
    background:#001100; color:#00ff7b; border:2px solid #00ff7b;
    border-radius:24px; padding:8px 12px; font-family:monospace; cursor:pointer;
    box-shadow:0 0 10px rgba(0,255,140,.35)
  }
  .slider{accent-color:#00ff7b; width:min(280px,60vw)}
</style>
</head>
<body>
<canvas class="matrix-bg" id="matrixBg" aria-hidden="true"></canvas>

<section class="promo">
  <h1 class="title">DM Panel PRO ‚Äî Turbo Master Dragon‚Ñ¢</h1>
  <p class="subtitle">Ambientaci√≥n Shaol√≠n + Consejos k√°rmicos. <strong>Abre, pulsa, juega</strong>. Sin distracciones.</p>
  <div class="cta">
    <button class="btn" id="btnAmbient"><span id="icoAmbient">‚ñ∂</span> Ambient: Iniciar</button>
    <button class="btn alt" id="btnSfxRandom">üé≤ SFX aleatorio</button>
    <button class="btn" id="btnStopAll">‚èπÔ∏è Parar todo</button>
  </div>
  <div class="cta">
    <label class="small">Volumen
      <input type="range" id="volMaster" class="slider" min="0" max="1" step="0.01" value="0.65" />
    </label>
    <label class="small">
      <input type="checkbox" id="ducking" checked />
      Bajar m√∫sica mientras habla el Maestro
    </label>
  </div>
  <div class="cta">
    <button class="btn alt" id="btnOpenModal">üßò Shaol√≠n Pro+ ‚Äî Selecci√≥n de efectos</button>
  </div>
</section>

<button id="soundToggle" aria-pressed="false">üîá Activar sonido</button>

<div class="wrap">
  <section class="grid">
    <!-- Maestro -->
    <div class="card">
      <h2 class="section">üßò Lectura del Maestro</h2>
      <p class="muted small">Pulsa para leer tu <strong>√∫ltima tirada</strong> (misma web, clave <code>karmicCalculator</code>) o pide una lectura aleatoria.</p>
      <div class="controls">
        <button class="btn" id="btnReadLast">üìñ Leer √∫ltima tirada</button>
        <button class="btn alt" id="btnRandomRead">üé≤ Lectura aleatoria</button>
        <button class="btn" id="btnVoiceToggle" aria-pressed="true">üó£Ô∏è Voz del Maestro: ON</button>
      </div>
      <div id="readingText" class="reading">El templo est√° en silencio. Pide una lectura‚Ä¶</div>
      <div class="controls">
        <button class="btn" id="btnRepeat">üîÅ Repetir</button>
        <button class="btn alt" id="btnSpeakStop">‚èπÔ∏è Parar voz</button>
      </div>
      <p id="sourceFlag" class="muted small"></p>
    </div>
<!-- ===== REVISAR KARMA (CTA) ===== -->
<section class="card" style="margin-top:16px; text-align:center">
  <h2 class="section">üßÆ Revisa tu Karma</h2>
  <p class="muted" style="max-width:720px;margin:0 auto 12px">
    Mira tu tirada actual en la Calculadora K√°rmica. Cada resultado es un espejo:
    no es castigo, es una lecci√≥n para romper el Samsara.
  </p>

  <div class="neon-bar" style="justify-content:center">
    <a class="btn-neon alt"
       href="https://karmalab-samsara.netlify.app/"
       target="_blank" rel="noopener">
      üßÆ Abrir Calculadora K√°rmica
    </a>
  </div>
<p class="muted" style="text-align:center;margin:8px 0 0">
  Haz tu tirada en la Calculadora y vuelve aqu√≠ para el consejo del Maestro.
</p>
  <p class="muted" style="max-width:680px;margin:10px auto 0; font-size:.92rem">
    Consejo: haz tu tirada y vuelve al Maestro Shaol√≠n para escuchar el consejo.
  </p>
</section>
    <!-- Voz y entrada simple -->
    <div class="card">
      <h2 class="section">üéõÔ∏è Voz y entrada manual</h2>
      <div class="stack">
        <label class="muted">Voz</label>
        <select id="voiceSelect" aria-label="Seleccionar voz"></select>
      </div>

      <div class="stack" style="margin-top:10px">
        <label class="muted">Resultado manual (r√°pido)</label>
        <div class="row">
          <select id="quickType" style="max-width:170px">
            <option value="dharma">DHARMA</option>
            <option value="karma">KARMA</option>
            <option value="interaction">INTERACCI√ìN</option>
          </select>
          <input id="quickText" type="text" placeholder="Ej: AVANCE R√ÅPIDO: +4 espacios" />
        </div>
        <button class="btn" id="btnQuickUse">‚úÖ Usar</button>
      </div>

      <p class="muted small" style="margin-top:12px">Tip: Usa <strong>Shaol√≠n Pro+</strong> para dar ambiente musical y <em>toques</em> en momentos clave.</p>
    </div>
  </section>

  <footer>
    ¬© 2025 Constantino y Federico Garc√≠a ‚Äî <em>Curvism instead cubism‚Ñ¢</em>.
    <div class="mini">Turbo Master Dragon‚Ñ¢ ¬∑ DM Panel PRO (v1).</div>
  </footer>
</div>

<!-- Modal SFX -->
<dialog id="sfxModal">
  <div class="modal-hdr">
    <strong>üßò Shaol√≠n Pro+ ‚Äî Efectos Especiales</strong>
    <button class="x" id="btnCloseModal">Cerrar</button>
  </div>
  <div class="stack" style="padding:12px 14px">
    <p class="muted small">Toca para disparar un efecto. Puedes encadenarlos; ‚Äú‚èπÔ∏è Parar todo‚Äù corta el ambiente y los SFX.</p>
    <div class="modal-grid" id="sfxList"></div>
  </div>
</dialog>

<!-- Audios base -->
<audio id="ambientAudio" src="https://federicogarcia.art/wp-content/uploads/2025/10/china-green-tea-380502.mp3" loop preload="auto" playsinline></audio>
<audio id="gongAudio"    src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_3b6a6c9e61.mp3?filename=gong-hit-105527.mp3" preload="auto" playsinline></audio>

<script>
/* ===== Fondo Matrix ===== */
(()=>{const c=document.getElementById('matrixBg'),x=c.getContext('2d');function R(){c.width=innerWidth;c.height=innerHeight}R();addEventListener('resize',R);
const A='„Ç¢„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É©„ÉØ0123456789‚òØKARMADHARMA'.split(''), fs=14;let cols=Math.floor(c.width/fs), drops=Array(cols).fill(1);
setInterval(()=>{ if(cols!==Math.floor(c.width/fs)){cols=Math.floor(c.width/fs);drops=Array(cols).fill(1)}
x.fillStyle='rgba(0,0,0,.06)'; x.fillRect(0,0,c.width,c.height);
x.fillStyle='#00ff7b'; x.font=fs+'px monospace';
for(let i=0;i<drops.length;i++){ x.fillText(A[(Math.random()*A.length)|0],i*fs,drops[i]*fs);
if(drops[i]*fs>c.height && Math.random()>0.975) drops[i]=0; drops[i]++; }
},33);})();

/* ===== Audio Manager (ambient + SFX + ducking) ===== */
const ambient = document.getElementById('ambientAudio');
const gong = document.getElementById('gongAudio');
const btnAmbient = document.getElementById('btnAmbient');
const icoAmbient = document.getElementById('icoAmbient');
const btnSfxRandom = document.getElementById('btnSfxRandom');
const btnStopAll = document.getElementById('btnStopAll');
const volMaster = document.getElementById('volMaster');
const ducking = document.getElementById('ducking');
const soundToggle = document.getElementById('soundToggle');

let audioReady=false;
function ensureAmbientUnlock(){
  if(audioReady) return;
  ambient.volume = volMaster.value;
  ambient.play().then(()=>{audioReady=true; soundToggle.textContent="üîä Silenciar"; soundToggle.setAttribute("aria-pressed","true");})
  .catch(()=>{});
}
addEventListener('pointerdown', function onFirst(){ensureAmbientUnlock(); removeEventListener('pointerdown', onFirst)}, {once:true});

soundToggle.addEventListener('click', ()=>{
  if(!audioReady){ensureAmbientUnlock(); return;}
  if(ambient.paused){ambient.play(); soundToggle.textContent="üîä Silenciar"; soundToggle.setAttribute("aria-pressed","true")}
  else{ambient.pause(); soundToggle.textContent="üîá Activar sonido"; soundToggle.setAttribute("aria-pressed","false")}
});

btnAmbient.addEventListener('click', ()=>{
  ensureAmbientUnlock();
  if(ambient.paused){ ambient.volume = volMaster.value; ambient.play(); icoAmbient.textContent='‚è∏'; btnAmbient.innerHTML = `${icoAmbient.outerText} Ambient: Pausar`; }
  else { ambient.pause(); icoAmbient.textContent='‚ñ∂'; btnAmbient.innerHTML = `${icoAmbient.outerText} Ambient: Iniciar`; }
});

volMaster.addEventListener('input', ()=>{
  const v = parseFloat(volMaster.value||'0.6');
  ambient.volume = v * (speakingActive && ducking.checked ? 0.35 : 1.0);
});

/* SFX library (pon tus archivos en /audio/shaolin/) */
const SFX = [
  "alone-samurai-in-mountain-430719.mp3",
  "asiatic-intro_3-283719.mp3",
  "birds-chirping-67827.mp3",
  "China-cymbal-transition-sound-effect.mp3",
  "chinese-beat-190047.mp3",
  "chinese-flute-hulusi-76116.mp3",
  "chinese-ident-transition-1-283708.mp3",
  "dizi-flute-02-72563.mp3",
  "fireworks-07-419025.mp3",
  "Gong-sound.mp3",
  "gongfeb11-91065.mp3",
  "INTROCHINO.mp3",
  "music-transition-ancient-back-etlx-247347.mp3",
  "spike-one-31462.mp3",
  "tibetan-buddhist-drum-314994.mp3"
];
function playSfx(name){
  const a = new Audio(`audio/shaolin/${name}`);
  a.volume = volMaster.value;
  a.play().catch(()=>{});
  return a;
}
btnSfxRandom.addEventListener('click', ()=>{
  const n = SFX[(Math.random()*SFX.length)|0];
  playSfx(n);
});
btnStopAll.addEventListener('click', ()=>{
  try{ ambient.pause(); ambient.currentTime = 0; }catch(_){}
  try{ speechSynthesis.cancel(); }catch(_){}
});

/* Modal SFX Pro+ */
const sfxModal = document.getElementById('sfxModal');
const btnOpenModal = document.getElementById('btnOpenModal');
const btnCloseModal = document.getElementById('btnCloseModal');
const sfxList = document.getElementById('sfxList');
btnOpenModal.addEventListener('click', ()=> sfxModal.showModal());
btnCloseModal.addEventListener('click', ()=> sfxModal.close());
SFX.forEach(n=>{
  const div = document.createElement('div'); div.className='sfx-item';
  const left = document.createElement('div'); left.textContent = n.replace(/\.mp3$/,'');
  const right = document.createElement('div');
  const b = document.createElement('button'); b.className='btn'; b.textContent='‚ñ∂ reproducir';
  b.addEventListener('click', ()=> playSfx(n));
  right.appendChild(b); div.append(left,right); sfxList.appendChild(div);
});

/* ===== Maestro Shaol√≠n (lectura) ===== */
const readingEl = document.getElementById('readingText');
const sourceFlag = document.getElementById('sourceFlag');
const btnReadLast = document.getElementById('btnReadLast');
const btnRandomRead = document.getElementById('btnRandomRead');
const btnRepeat = document.getElementById('btnRepeat');
const btnSpeakStop = document.getElementById('btnSpeakStop');
const btnVoiceToggle = document.getElementById('btnVoiceToggle');
const voiceSelect = document.getElementById('voiceSelect');
const quickType = document.getElementById('quickType');
const quickText = document.getElementById('quickText');
const btnQuickUse = document.getElementById('btnQuickUse');

let voices=[], currentVoice=null, voiceOn=true, speakingActive=false;

function populateVoices(){
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML='';
  const es = voices.filter(v=>v.lang && v.lang.toLowerCase().startsWith('es'));
  const list = es.length? es : voices;
  list.forEach(v=>{
    const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} ‚Äî ${v.lang}`; voiceSelect.appendChild(o);
  });
  currentVoice = list[0] || voices[0] || null;
}
if('speechSynthesis' in window){
  populateVoices();
  window.speechSynthesis.onvoiceschanged = populateVoices;
}
voiceSelect.addEventListener('change', ()=>{
  const v = voices.find(v=>v.name===voiceSelect.value);
  if(v) currentVoice=v;
});
btnVoiceToggle.addEventListener('click', ()=>{
  voiceOn=!voiceOn;
  btnVoiceToggle.textContent = voiceOn? "üó£Ô∏è Voz del Maestro: ON" : "ü§´ Voz del Maestro: OFF";
  btnVoiceToggle.setAttribute('aria-pressed', voiceOn? 'true':'false');
});

const FALLBACK_KARMA = [
  {type:"karma",  result:"AUTOGOL: Retrocede 3 espacios"},
  {type:"karma",  result:"P√âRDIDA DE TURNO por arrogancia espiritual"},
  {type:"dharma", result:"AVANCE R√ÅPIDO: +4 espacios"},
  {type:"dharma", result:"INMUNIDAD K√ÅRMICA por 1 turno"},
  {type:"dharma", result:"DOBLE MOVIMIENTO en tu siguiente ronda"}
];
function getLastKarmicFromLocalStorage(){
  try{
    const raw = localStorage.getItem("karmicCalculator"); if(!raw) return null;
    const data = JSON.parse(raw); const hist = Array.isArray(data.history)? data.history : [];
    if(!hist.length) return null; const last = hist[0];
    if(last.from==='roulette' && last.fullData?.result){ return {type:last.to, result:last.fullData.result}; }
    if(last.description && (last.description.startsWith('KARMA')||last.description.startsWith('DHARMA'))){
      const [k,...rest]=last.description.split(':'); return {type:k.toLowerCase(), result:rest.join(':').trim()};
    }
    if(last.fullData?.difficulty!==undefined){
      const desc=last.description||""; const p=desc.split('‚Üí');
      const from=(p[0]||'Humano').trim(); const to=(p[1]||'Humano').split(':')[0].trim();
      return {type:'interaction', result:`Interacci√≥n ${from} ‚Üí ${to} (dif. ${last.fullData.difficulty})`};
    }
  }catch(e){}
  return null;
}
function forgeReading(payload){
  const intros=[
    "El bamb√∫ se inclina, pero no se quiebra.",
    "Respira hondo. Observa sin juicio.",
    "Cuando la mente se aquieta, el camino aparece.",
    "Quien empuja el r√≠o, solo se cansa."
  ];
  const outro=[
    "Camina suave. La salida est√° en tu siguiente decisi√≥n.",
    "Suelta un poco hoy, para andar m√°s lejos ma√±ana.",
    "El dado cae, pero tu intenci√≥n lo gu√≠a.",
    "Mira la luna y recuerda: no eres tus sombras."
  ];
  let cuerpo="";
  if(payload?.type==="karma"){
    cuerpo=`Veo carga activa: ${payload.result}. No luches contra el golpe; absorbe y redirige. Practica una renuncia peque√±a ahora.`;
  }else if(payload?.type==="dharma"){
    cuerpo=`Llega viento propicio: ${payload.result}. √ösalo tambi√©n para levantar a otro. Compartir te har√° m√°s ligero.`;
  }else if(payload?.type==="interaction"){
    cuerpo=`Cruce entre fuerzas: ${payload.result}. Observa el apego que empuja. Elige la opci√≥n con menos orgullo.`;
  }else{
    const rnd=FALLBACK_KARMA[(Math.random()*FALLBACK_KARMA.length)|0];
    cuerpo=`Sin se√±ales recientes, leo el pulso: ${rnd.type.toUpperCase()} ‚Äî ${rnd.result}. Da el siguiente paso con humildad.`;
  }
  return `${intros[(Math.random()*intros.length)|0]}\n${cuerpo}\n${outro[(Math.random()*outro.length)|0]}`;
}
function speak(text){
  if(!voiceOn || !('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text);
  if(currentVoice) u.voice = voices.find(v=>v.name===currentVoice.name) || currentVoice;
  u.lang=(u.voice && u.voice.lang) ? u.voice.lang : 'es-ES';
  u.rate=0.95; u.pitch=1.0; u.volume=1.0;
  speakingActive=true;
  if(ducking.checked){ ambient.volume = parseFloat(volMaster.value) * 0.35; }
  u.onend=()=>{ speakingActive=false; ambient.volume = parseFloat(volMaster.value);
    try{ gong.currentTime=0; gong.volume=0.55; gong.play().catch(()=>{});}catch(_){}
  };
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

/* Botones Maestro */
btnReadLast.addEventListener('click', ()=>{
  let payload = getLastKarmicFromLocalStorage();
  let src = payload? "Fuente: Calculadora (localStorage)." : "";
  if(!payload){ payload = FALLBACK_KARMA[(Math.random()*FALLBACK_KARMA.length)|0]; src="Fuente: Respaldo aleatorio."; }
  const t=forgeReading(payload); readingEl.textContent=t; sourceFlag.textContent=src; speak(t);
});
btnRandomRead.addEventListener('click', ()=>{
  const payload = FALLBACK_KARMA[(Math.random()*FALLBACK_KARMA.length)|0];
  const t=forgeReading(payload); readingEl.textContent=t; sourceFlag.textContent="Fuente: Aleatoria (fallback)."; speak(t);
});
btnRepeat.addEventListener('click', ()=>{ const t=readingEl.textContent.trim(); if(t) speak(t); });
btnSpeakStop.addEventListener('click', ()=>{ try{speechSynthesis.cancel(); speakingActive=false; ambient.volume=parseFloat(volMaster.value);}catch(_){}});

/* Quick input */
btnQuickUse.addEventListener('click', ()=>{
  const type = quickType.value;
  const text = (quickText.value||'').trim() || (type==='dharma'?'AVANCE R√ÅPIDO: +4 espacios':'Retrocede 1 espacio');
  const payload = {type, result:text};
  const t=forgeReading(payload); readingEl.textContent=t; sourceFlag.textContent="Fuente: Manual (r√°pido)."; speak(t);
});
</script>
</body>
</html>