<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DM Panel PRO ‚Äî Turbo Master Dragon‚Ñ¢</title>
<meta name="theme-color" content="#00ff7b" />
<meta name="description" content="Ambient √©pico + SFX por categor√≠as con mezcla en paralelo, LEDs de pista activa y controles r√°pidos.">
<style>
  :root{
    --green:#00ff7b; --accent:#ffd166; --line:#113c2d;
    --panel:#06130f; --panel2:#0a1d17; --text:#eafff5;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:#000; color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    line-height:1.55; overflow-x:hidden;
  }
  .wrap{max-width:1100px; margin:0 auto; padding:18px 14px}
  header.hero{
    margin-top:18px; margin-bottom:16px; text-align:center;
    padding:18px; border:1px solid var(--line); border-radius:14px; background:var(--panel);
    box-shadow:0 0 38px rgba(0,255,150,.08), inset 0 0 22px rgba(0,255,140,.04);
  }
  .title{font-size:clamp(24px,4.2vw,40px); font-weight:900; letter-spacing:.04em;
    color:var(--green); text-shadow:0 0 16px rgba(0,255,150,.6);}
  .subtitle{color:#cfe; opacity:.95; margin-top:6px}
  .cta{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:999px; border:1px solid var(--green);
    background:linear-gradient(180deg,#02140f,#031b14); color:var(--green); text-decoration:none;
    font-weight:800; letter-spacing:.02em; cursor:pointer;
    box-shadow:0 0 10px var(--green),0 0 18px rgba(0,255,140,.45);
    transition:transform .12s ease, box-shadow .2s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 0 16px var(--green),0 0 32px rgba(0,255,140,.55)}
  .btn.alt{ border-color:var(--accent); color:var(--accent);
    box-shadow:0 0 10px var(--accent),0 0 18px rgba(255,209,102,.45)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
  .slider{accent-color:#00ff7b; width:min(280px,60vw)}
  .small{font-size:.92rem; opacity:.92; color:#cfe}
  footer{margin:22px 0 18px; text-align:center; color:#9edfc9; font-size:.95rem; border-top:1px solid var(--line); padding-top:12px}
  .mini{opacity:.75; font-size:.9rem; margin-top:6px}

  /* ===== Shaol√≠n Pro+ (modal SFX) ===== */
  dialog#sfxModal{
    width:min(860px,94vw); background:#041510; border:1px solid var(--line);
    border-radius:16px; color:var(--text);
    box-shadow:0 10px 40px rgba(0,0,0,.6), 0 0 32px rgba(0,255,150,.15);
  }
  dialog#sfxModal::backdrop{ background:rgba(0,0,0,.6) }
  .sfx-hdr{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line)}
  .sfx-body{padding:12px 14px}
  .sfx-acc{border:1px solid var(--line);border-radius:10px;background:#071c16}
  .sfx-acc summary{list-style:none;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;cursor:pointer}
  .sfx-list{display:grid;gap:8px;padding:10px 14px}
  .sfx-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#041a14}
  .sfx-name{color:#cfe;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .led{width:10px;height:10px;border-radius:999px;background:#2b4038;box-shadow:0 0 0 0 transparent;display:inline-block;margin-right:6px;vertical-align:middle}
  .led.on{background:#00ff7b; box-shadow:0 0 12px #00ff7b}
  .small-muted{font-size:.9rem;opacity:.9;color:#9edfc9}
</style>
</head>
<style>
  /* Sirena + luces */
  #sirenaToggle{
    position:fixed; right:16px; bottom:16px; z-index:10000;
    background:#220000; color:#ffaaaa; border:2px solid #ff6666;
    border-radius:999px; padding:10px 16px; font-weight:900; font-family:ui-sans-serif;
    box-shadow:0 0 18px rgba(255,80,80,.5); cursor:pointer; transition:transform .15s ease, box-shadow .2s;
  }
  #sirenaToggle:hover{ transform:scale(1.05); box-shadow:0 0 28px rgba(255,80,80,.7); }

  #lucesEmergencia{ position:fixed; inset:0; pointer-events:none; z-index:9999; opacity:0; }
  #lucesEmergencia.active{ opacity:.65; animation:luces 1.1s infinite; }
  @keyframes luces{
    0%,100%{ box-shadow: inset 0 0 200vmax rgba(255,40,40,.35); }
    50%    { box-shadow: inset 0 0 200vmax rgba(40,120,255,.35); }
  }
</style>
<!-- Sirena + luces (poner justo antes de </body>) -->
<div id="lucesEmergencia" hidden></div>

<button id="sirenaToggle" aria-pressed="true">
  üö® SIRENA ON ‚Äî ¬°Ap√°gala si puedes!
</button>

<audio id="sirenaAudio"
       src="audio/alarms/ambulance-uk.mp3"
       preload="auto" loop playsinline></audio>
<body>
<div class="wrap">
  <header class="hero">
    <div class="title">DM Panel PRO ‚Äî Turbo Master Dragon‚Ñ¢</div>
    <div class="subtitle">Intros √©picos, ambientaci√≥n de pel√≠cula y cura inmediata para juegos aburridos.</div>
    <div class="cta">
      <button class="btn" id="btnAmbient"><span id="icoAmbient">‚ñ∂</span> Ambient: Iniciar</button>
      <button class="btn" id="btnStopAll">‚õî Parar TODO</button>
      <button class="btn alt" id="btnOpenModal">üßò Shaol√≠n Pro+ ‚Äî Efectos</button>
    </div>

    <div class="row" style="margin-top:8px">
      <label class="small">Volumen
        <input type="range" id="volMaster" class="slider" min="0" max="1" step="0.01" value="0.7" />
      </label>
      <label class="small">Intro
        <select id="introStyle">
          <option value="epic">√âpica (fanfarria)</option>
          <option value="shaolin">M√≠stica Shaol√≠n</option>
          <option value="curvista">Curvista ligera</option>
        </select>
      </label>
      <span class="small">Reproduciendo: <strong id="playingCount">0</strong></span>
    </div>
  </header>

  <section class="small" style="text-align:center">
    Consejo: toca ‚ÄúAmbient: Iniciar‚Äù y comienza el espect√°culo.  
    La intro elegida suena (2‚Äì3 clips encadenados) y luego entra el Ambient en loop.  
    En el modal puedes mezclar **varios SFX** a la vez. LED verde = pista activa.
  </section>

  <footer>
    ¬© 2025 Constantino y Federico Garc√≠a ‚Äî <em>Curvism instead cubism‚Ñ¢</em>.
    <div class="mini">DM Panel PRO ¬∑ Intros + Mezcla SFX.</div>
  </footer>
</div>

<!-- Ambient de fondo (loop) -->
<audio id="ambientAudio" src="audio/transitions/dron-dos-minutos.mp3" loop preload="auto" playsinline></audio>

<!-- === Shaol√≠n Pro+ ‚Äî Modal de Efectos === -->
<dialog id="sfxModal">
  <div class="sfx-hdr">
    <strong>üßò Shaol√≠n Pro+ ‚Äî Efectos por categor√≠a</strong>
    <div style="display:flex;gap:8px">
      <button class="btn" id="btnStopLastSfx">‚èπ Parar √∫ltimo</button>
      <button class="btn" id="btnStopAllSfx">üõë Parar TODO</button>
      <button class="btn alt" id="btnCloseSfx">Cerrar</button>
    </div>
  </div>
  <div class="sfx-body">
    <p class="small-muted">Puedes disparar varios sonidos a la vez (ej: <em>ambiente + flecha + tigre</em>). Un LED verde indica qu√© pistas est√°n sonando.</p>
    <div id="sfxCats" class="sfx-cats"></div>
    <p class="small-muted" style="margin-top:8px">Reproduciendo: <span id="sfxCount">0</span></p>
    <div id="sfxError" class="small-muted" style="display:none;color:#ffb3b3">No se pudo leer <code>efectos.json</code>. Abre desde Netlify o con un servidor local (no <code>file://</code>).</div>
  </div>
</dialog>

<script>
/* ================== INTROS + AMBIENT ================== */
(function(){
  const ambient     = document.getElementById('ambientAudio');
  const btnAmbient  = document.getElementById('btnAmbient');
  const btnStopAll  = document.getElementById('btnStopAll');
  const volMaster   = document.getElementById('volMaster');
  const introSelect = document.getElementById('introStyle');
  const playingCount= document.getElementById('playingCount');

  // icono (asegura presencia)
  const ico = (function(){
    let i = document.getElementById('icoAmbient');
    if(!i){ i = document.createElement('span'); i.id='icoAmbient'; i.textContent='‚ñ∂'; btnAmbient?.insertBefore(i,btnAmbient.firstChild); }
    return i;
  })();

  // helper de URL para archivos con espacios
  function urlFor(cat, name){
    return `audio/${cat}/${encodeURIComponent(name)}`;
  }

  // set de audios en curso (ambient + intros)
  const active = new Set();
  function updateCount(){ playingCount.textContent = String(active.size); }

  const INTROS = {
    // 1) fanfarria + tambores + aplauso
    epic: [
      {cat:'transitions', name:'fanfarra-epic.mp3'},
      {cat:'battle',      name:'horde-war-drums-loop.mp3'},
      {cat:'scene',       name:'ten-seconds-applause.mp3'}
    ],
    // 2) gong + flauta india + campanillas
    shaolin: [
      {cat:'bless',   name:'gong-dong-gong.mp3'},
      {cat:'bless',   name:'indian-flute-music-soothing.mp3'},
      {cat:'bless',   name:'wind-chime-ambience.mp3'}
    ],
    // 3) aplausos suaves + arpa m√°gica + barrida descendente
    curvista: [
      {cat:'transitions', name:'intro-30-secs-claping.mp3'},
      {cat:'bless',       name:'magic harp-arpeggio.mp3'},
      {cat:'transitions', name:'downsweep-sound-effect.mp3'}
    ]
  };

  let audioUnlock = false;
  let introAudio  = null;
  let introIdx    = 0;
  let introPlaying= false;

  // guarda/recupera estilo
  try{
    const saved = localStorage.getItem('dm_intro_style');
    if (saved && INTROS[saved]) introSelect.value = saved;
  }catch(_){}
  introSelect.addEventListener('change', ()=>{
    try{ localStorage.setItem('dm_intro_style', introSelect.value); }catch(_){}
  });

  function currentVol(){
    const v = parseFloat(volMaster.value || '0.7');
    return isNaN(v) ? 0.7 : v;
  }

  function unlockOnce(){
    if (audioUnlock) return;
    const a = new Audio();
    a.play().catch(()=>{});
    audioUnlock = true;
  }
  window.addEventListener('pointerdown', unlockOnce, {once:true});

  function setBtnPlaying(on){
    if (!btnAmbient) return;
    ico.textContent = on ? '‚è∏' : '‚ñ∂';
    btnAmbient.innerHTML = '';
    btnAmbient.appendChild(ico);
    btnAmbient.appendChild(document.createTextNode(' Ambient: ' + (on ? 'Pausar' : 'Iniciar')));
  }

  function startAmbient(){
    try{ ambient.volume = currentVol(); ambient.play().then(()=>{active.add(ambient); updateCount();}).catch(()=>{}); }catch(_){}
    setBtnPlaying(true);
  }
  function stopAmbient(){
    try{ ambient.pause(); ambient.currentTime = 0; active.delete(ambient); updateCount(); }catch(_){}
    setBtnPlaying(false);
  }

  function playIntroSeq(){
    if (introPlaying) return;
    introPlaying = true; introIdx = 0;
    const seq = INTROS[introSelect.value] || INTROS.epic;

    const next = ()=>{
      if (introIdx >= seq.length){
        introPlaying = false;
        startAmbient();
        return;
      }
      const {cat,name} = seq[introIdx++];
      const url = urlFor(cat, name);
      try{
        if (introAudio){ introAudio.onended=null; try{active.delete(introAudio);}catch(_){} }
        introAudio = new Audio(url);
        introAudio.volume = currentVol();
        introAudio.onended = ()=>{ active.delete(introAudio); updateCount(); next(); };
        introAudio.play().then(()=>{ active.add(introAudio); updateCount(); }).catch(()=>{ next(); });
      }catch(_){ next(); }
    };

    next();
  }

  volMaster.addEventListener('input', ()=>{
    const v = currentVol();
    try{ ambient.volume = v; }catch(_){}
    try{ if (introAudio) introAudio.volume = v; }catch(_){}
  });

  btnAmbient.addEventListener('click', ()=>{
    unlockOnce();
    if (introPlaying){
      // cancelar intro
      try{ introAudio?.pause(); introAudio.currentTime=0; active.delete(introAudio); }catch(_){}
      introPlaying = false; introAudio=null; updateCount();
      setBtnPlaying(false);
      return;
    }
    if (ambient.paused){ playIntroSeq(); }
    else { stopAmbient(); }
  });

  btnStopAll.addEventListener('click', ()=>{
    // parar intro
    try{ introAudio?.pause(); introAudio.currentTime=0; active.delete(introAudio); }catch(_){}
    introPlaying=false; introAudio=null;
    // parar ambient
    stopAmbient();
    updateCount();
  });
})();
</script>

<script>
/* ================== SHAOL√çN PRO+ ‚Äî SFX POR CATEGOR√çAS ================== */
(function(){
  const openBtn   = document.getElementById('btnOpenModal');
  const modal     = document.getElementById('sfxModal');
  const closeBtn  = document.getElementById('btnCloseSfx');
  const listWrap  = document.getElementById('sfxCats');
  const errBox    = document.getElementById('sfxError');
  const cntEl     = document.getElementById('sfxCount');
  const stopLastB = document.getElementById('btnStopLastSfx');
  const stopAllB  = document.getElementById('btnStopAllSfx');

  // estado SFX (independiente del ambient/intro)
  const active = new Set(); // Audio
  const stack  = [];        // {a, led}

  function updateCount(){ cntEl.textContent = String(active.size); }

  function play(url, led){
    const a = new Audio(url);
    a.volume = 0.9;
    a.addEventListener('ended', ()=>{
      active.delete(a);
      led?.classList.remove('on');
      updateCount();
    });
    a.play().then(()=>{
      active.add(a); stack.push({a,led});
      led?.classList.add('on');
      updateCount();
    }).catch(()=>{ /* nada */ });
    return a;
  }

  function stopLast(){
    while (stack.length){
      const top = stack.pop();
      if (active.has(top.a)){
        try{ top.a.pause(); top.a.currentTime=0; }catch(_){}
        active.delete(top.a);
        top.led?.classList.remove('on');
        break;
      }
    }
    updateCount();
  }

  function stopAll(){
    active.forEach(a=>{ try{ a.pause(); a.currentTime=0; }catch(_){} });
    active.clear();
    listWrap.querySelectorAll('.led.on').forEach(x=>x.classList.remove('on'));
    updateCount();
  }

  stopLastB.addEventListener('click', stopLast);
  stopAllB .addEventListener('click', stopAll);
  openBtn  .addEventListener('click', ()=> modal.showModal());
  closeBtn .addEventListener('click', ()=> modal.close());

  // helpers
  function urlFor(cat, name){
    return `audio/${cat}/${encodeURIComponent(name)}`;
  }

  // construir acordeones desde efectos.json
  fetch('efectos.json', {cache:'no-store'})
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(raw=>{
      const ORDER = ["alarms","animal","battle","bless","nature","ritual","scene","transitions"];
      const LABEL = { alarms:"ALARMS", animal:"ANIMAL", battle:"BATTLE", bless:"BLESS", nature:"NATURE", ritual:"RITUAL", scene:"SCENE", transitions:"TRANSITIONS" };

      // normalizar claves (por si vinieron con espacios)
      const data = {};
      for (const [k,v] of Object.entries(raw)){
        data[k.trim().toLowerCase()] = Array.isArray(v) ? v.slice().sort() : [];
      }

      ORDER.forEach(cat=>{
        const files = data[cat] || [];
        const det = document.createElement('details');
        det.className = 'sfx-acc';

        const sum = document.createElement('summary');
        sum.innerHTML = `<span style="color:#eafff5;font-weight:800;letter-spacing:.02em">${LABEL[cat]||cat.toUpperCase()}</span>
                         <span style="opacity:.8;color:#9edfc9">${files.length} pista(s)</span>`;

        const body = document.createElement('div');
        body.className = 'sfx-list';

        if (!files.length){
          const p = document.createElement('p');
          p.className = 'small-muted';
          p.textContent = 'Sin pistas en esta categor√≠a.';
          body.appendChild(p);
        } else {
          files.forEach(name=>{
            const row = document.createElement('div');
            row.className = 'sfx-row';

            const left = document.createElement('div');
            const led  = document.createElement('span'); led.className='led';
            const nm   = document.createElement('span'); nm.className='sfx-name'; nm.textContent = name.replace(/\.mp3$/,'');
            left.append(led, nm);

            const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
            const bPlay = document.createElement('button'); bPlay.className='btn';     bPlay.textContent='‚ñ∂ Reproducir';
            const bStop = document.createElement('button'); bStop.className='btn alt'; bStop.textContent='‚èπ Parar √∫ltimo';

            bPlay.addEventListener('click', ()=> play(urlFor(cat, name), led));
            bStop.addEventListener('click', stopLast);

            right.append(bPlay,bStop);
            row.append(left,right);
            body.appendChild(row);
          });
        }

        det.append(sum, body);
        listWrap.appendChild(det);
      });
    })
    .catch(()=>{ errBox.style.display='block'; });
})();
</script>
</body>
</html>