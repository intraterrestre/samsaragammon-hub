<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DM Panel PRO ‚Äî Turbo Master Dragon‚Ñ¢</title>
<meta name="theme-color" content="#00ff7b" />
<meta name="description" content="Panel para Masters: Ambient, SFX en paralelo por categor√≠as, parar √∫ltimo y todo.">
<style>
  :root{ --green:#00ff7b; --accent:#ffd166; --line:#113c2d; --panel:#06130f; --panel2:#0a1d17; --text:#eafff5; }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{ background:#000; color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; line-height:1.55; overflow-x:hidden; }
  .wrap{max-width:1100px; margin:0 auto; padding:18px 14px}
  header.hero{ margin-top:18px; margin-bottom:16px; text-align:center; padding:18px; border:1px solid var(--line); border-radius:14px; background:var(--panel); box-shadow:0 0 38px rgba(0,255,150,.08), inset 0 0 22px rgba(0,255,140,.04); }
  .title{font-size:clamp(24px,4.2vw,40px); font-weight:900; letter-spacing:.04em; color:var(--green); text-shadow:0 0 16px rgba(0,255,150,.6);}
  .subtitle{color:#cfe; opacity:.95; margin-top:6px}
  .cta{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    padding:10px 14px; border-radius:999px; border:1px solid var(--green);
    background:linear-gradient(180deg,#02140f,#031b14); color:var(--green); text-decoration:none;
    font-weight:800; letter-spacing:.02em; cursor:pointer;
    box-shadow:0 0 10px var(--green),0 0 18px rgba(0,255,140,.45);
    transition:transform .12s ease, box-shadow .2s ease;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 0 16px var(--green),0 0 32px rgba(0,255,140,.55)}
  .btn.alt{ border-color:var(--accent); color:var(--accent); box-shadow:0 0 10px var(--accent),0 0 18px rgba(255,209,102,.45)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
  .slider{accent-color:#00ff7b; width:min(280px,60vw)}
  .small{font-size:.92rem; opacity:.92; color:#cfe}
  footer{margin:22px 0 18px; text-align:center; color:#9edfc9; font-size:.95rem; border-top:1px solid var(--line); padding-top:12px}
  .mini{opacity:.75; font-size:.9rem; margin-top:6px}

  /* Modal (nativo) */
  dialog#sfxModal{
    width:min(860px,94vw); background:#041510; border:1px solid var(--line);
    border-radius:16px; color:var(--text);
    box-shadow:0 10px 40px rgba(0,0,0,.6), 0 0 32px rgba(0,255,150,.15);
  }
  dialog::backdrop{ background:rgba(0,0,0,.6) }
  .modal-hdr{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line)}
  .x{background:transparent; border:1px solid var(--line); color:#9edfc9; padding:8px 10px; border-radius:10px; cursor:pointer}
  .stack{display:grid; gap:10px}
  /* Fallback modal (para navegadores sin <dialog>) */
  .fallback{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999; }
  .fallback .box{ width:min(860px,94vw); background:#041510; border:1px solid var(--line); border-radius:16px; color:var(--text); box-shadow:0 10px 40px rgba(0,0,0,.6), 0 0 32px rgba(0,255,150,.15); }
</style>
</head>
<body>
<div class="wrap">
  <header class="hero">
    <div class="title">DM Panel PRO ‚Äî Turbo Master Dragon‚Ñ¢</div>
    <div class="subtitle">Ambientaci√≥n + Efectos (SFX = efectos de sonido). Pulsa, mezcla, corta.</div>
    <div class="cta">
      <button class="btn" id="btnAmbient"><span id="icoAmbient">‚ñ∂</span> Ambient: Iniciar</button>
      <button class="btn alt" id="btnOpenModal">üßò Shaol√≠n Pro+ ‚Äî Selecci√≥n de efectos</button>
      <button class="btn" id="btnStopLastHdr">‚èπÔ∏è Parar √∫ltimo</button>
      <button class="btn" id="btnStopAllHdr">‚õî Parar TODO</button>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="small">Volumen
        <input type="range" id="volMaster" class="slider" min="0" max="1" step="0.01" value="0.7" />
      </label>
      <span id="playingCount" class="small">Reproduciendo: 0</span>
    </div>
  </header>

  <section class="small" style="text-align:center">
    Consejo: puedes disparar varios sonidos a la vez (por ejemplo, <em>ambiente</em> + <em>flecha</em> + <em>tigre</em>). ‚ÄúParar √∫ltimo‚Äù corta el m√°s reciente; ‚ÄúParar TODO‚Äù silencia todo.
  </section>

  <footer>
    ¬© 2025 Constantino y Federico Garc√≠a ‚Äî <em>Curvism instead cubism‚Ñ¢</em>.
    <div class="mini">DM Panel PRO ¬∑ Mezcla SFX por categor√≠as.</div>
  </footer>
</div>

<!-- Modal nativo -->
<dialog id="sfxModal">
  <div class="modal-hdr">
    <strong>üßò Shaol√≠n Pro+ ‚Äî Efectos por categor√≠a</strong>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn alt" id="btnStopLastModal">‚èπ Parar √∫ltimo</button>
      <button class="btn" id="btnStopAllModal">üõë Parar TODO</button>
      <button class="x" id="btnCloseModal">Cerrar</button>
    </div>
  </div>
  <div class="stack" style="padding:12px 14px">
    <p class="small">Puedes disparar varios sonidos a la vez (ej: <em>ambiente + flecha + tigre</em>). ‚ÄúParar √∫ltimo‚Äù corta el m√°s reciente; ‚ÄúParar TODO‚Äù silencia todo.</p>
    <div id="sfxCats" class="stack"></div>
    <p class="small" style="margin-top:8px">Reproduciendo: <span id="sfxCount">0</span></p>
    <div id="sfxError" class="small" style="display:none;color:#ffb3b3">No se encontr√≥ <code>efectos.json</code>.</div>
  </div>
</dialog>

<!-- Fallback para navegadores sin <dialog> -->
<div id="fallbackModal" class="fallback" aria-hidden="true">
  <div class="box">
    <div class="modal-hdr">
      <strong>üßò Shaol√≠n Pro+ ‚Äî Efectos por categor√≠a</strong>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn alt" id="btnStopLastFb">‚èπ Parar √∫ltimo</button>
        <button class="btn" id="btnStopAllFb">üõë Parar TODO</button>
        <button class="x" id="btnCloseFb">Cerrar</button>
      </div>
    </div>
    <div class="stack" style="padding:12px 14px">
      <p class="small">Puedes disparar varios sonidos a la vez (ej: <em>ambiente + flecha + tigre</em>).</p>
      <div id="sfxCatsFb" class="stack"></div>
      <p class="small" style="margin-top:8px">Reproduciendo: <span id="sfxCountFb">0</span></p>
      <div id="sfxErrorFb" class="small" style="display:none;color:#ffb3b3">No se encontr√≥ <code>efectos.json</code>.</div>
    </div>
  </div>
</div>

<!-- Audios base -->
<audio id="ambientAudio" src="https://cdn.pixabay.com/download/audio/2021/10/27/audio_0d2ddf4a1a.mp3?filename=windy-ambient-111677.mp3" loop preload="auto" playsinline></audio>

<script>
/* ===== Ambient y contador ===== */
const ambient = document.getElementById('ambientAudio');
const btnAmbient = document.getElementById('btnAmbient');
const icoAmbient = document.getElementById('icoAmbient');
const volMaster = document.getElementById('volMaster');
const playingCount = document.getElementById('playingCount');

let audioReady=false;
function ensureUnlock(){
  if(audioReady) return;
  ambient.volume = parseFloat(volMaster.value||'0.7');
  ambient.play().then(()=>{ audioReady=true; btnAmbient.dataset.on="1"; icoAmbient.textContent='‚è∏'; btnAmbient.lastChild.textContent=' Ambient: Pausar'; }).catch(()=>{});
}
addEventListener('pointerdown', function onFirst(){ ensureUnlock(); removeEventListener('pointerdown', onFirst) }, {once:true});

btnAmbient.addEventListener('click', ()=>{
  ensureUnlock();
  if(ambient.paused){ ambient.volume=parseFloat(volMaster.value||'0.7'); ambient.play(); icoAmbient.textContent='‚è∏'; btnAmbient.lastChild.textContent=' Ambient: Pausar'; }
  else{ ambient.pause(); icoAmbient.textContent='‚ñ∂'; btnAmbient.lastChild.textContent=' Ambient: Iniciar'; }
});
volMaster.addEventListener('input', ()=> ambient.volume = parseFloat(volMaster.value||'0.7'));
</script>

<script>
/* ===== Mezcla SFX por categor√≠as ===== */
(function(){
  const hasDialog = !!window.HTMLDialogElement;
  const modal      = document.getElementById('sfxModal');
  const fb         = document.getElementById('fallbackModal');
  const openBtn    = document.getElementById('btnOpenModal');
  const closeBtn   = document.getElementById('btnCloseModal');
  const sfxCats    = document.getElementById('sfxCats');
  const err        = document.getElementById('sfxError');
  const countEl    = document.getElementById('sfxCount');

  // Fallback refs
  const closeFb    = document.getElementById('btnCloseFb');
  const sfxCatsFb  = document.getElementById('sfxCatsFb');
  const errFb      = document.getElementById('sfxErrorFb');
  const countFb    = document.getElementById('sfxCountFb');

  // Botones de parada (header + modal + fallback)
  const btnStopLastHdr = document.getElementById('btnStopLastHdr');
  const btnStopAllHdr  = document.getElementById('btnStopAllHdr');
  const btnStopLastModal = document.getElementById('btnStopLastModal');
  const btnStopAllModal  = document.getElementById('btnStopAllModal');
  const btnStopLastFb    = document.getElementById('btnStopLastFb');
  const btnStopAllFb     = document.getElementById('btnStopAllFb');

  // Estado global de mezclas
  const active = new Set(); // <Audio>
  const stack  = [];        // LIFO para ‚ÄúParar √∫ltimo‚Äù
  function refreshCount(){
    const n = String(active.size);
    countEl.textContent = n;
    countFb.textContent = n;
    playingCount.textContent = "Reproduciendo: " + n;
  }
  function playSfx(url){
    const a = new Audio(url);
    a.volume = parseFloat(volMaster.value || '0.7');
    a.addEventListener('ended', ()=>{ active.delete(a); refreshCount(); });
    a.play().then(()=>{ active.add(a); stack.push(a); refreshCount(); }).catch(()=>{});
    return a;
  }
  function stopLast(){
    while (stack.length){
      const a = stack.pop();
      if (active.has(a)){
        try{ a.pause(); a.currentTime = 0; }catch(_){}
        active.delete(a); break;
      }
    }
    refreshCount();
  }
  function stopAll(){
    active.forEach(a=>{ try{ a.pause(); a.currentTime = 0; }catch(_){} });
    active.clear(); refreshCount();
  }
  [btnStopLastHdr,btnStopLastModal,btnStopLastFb].forEach(b=>b?.addEventListener('click',stopLast));
  [btnStopAllHdr,btnStopAllModal,btnStopAllFb].forEach(b=>b?.addEventListener('click',stopAll));

  // Abrir/Cerrar modal
  openBtn.addEventListener('click', ()=>{ hasDialog ? modal.showModal() : (fb.style.display='flex'); });
  closeBtn?.addEventListener('click', ()=> modal.close());
  closeFb?.addEventListener('click', ()=> fb.style.display='none');

  // Cargar lista
  fetch('./efectos.json', {cache:'no-store'})
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(raw => {
      const norm = {};
      for (const [k,v] of Object.entries(raw)){ norm[k.trim().toLowerCase()] = Array.isArray(v)? v.slice().sort():[]; }
      const ORDER = ["alarms","animal","battle","bless","nature","ritual","scene","transitions"];
      const LABEL = { alarms:"ALARMS", animal:"ANIMAL", battle:"BATTLE", bless:"BLESS", nature:"NATURE", ritual:"RITUAL", scene:"SCENE", transitions:"TRANSITIONS" };
      function build(into){
        ORDER.forEach(key=>{
          const list = norm[key] || [];
          const det = document.createElement('details');
          det.style.cssText="border:1px solid #113c2d;border-radius:10px;background:#071c16";
          const sum = document.createElement('summary');
          sum.style.cssText="list-style:none;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer";
          sum.innerHTML = `<span style="color:#eafff5;font-weight:800;letter-spacing:.02em">${LABEL[key]||key.toUpperCase()}</span>
                           <span style="opacity:.8;color:#9edfc9">${list.length} pista(s)</span>`;
          const body = document.createElement('div');
          body.style.cssText="padding:10px 14px;display:grid;gap:8px";
          if(!list.length){
            const p=document.createElement('p'); p.className='small'; p.textContent='Sin pistas en esta categor√≠a.'; body.appendChild(p);
          }else{
            list.forEach(file=>{
              const row=document.createElement('div');
              row.style.cssText="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border:1px solid #113c2d;border-radius:10px;background:#041a14";
              const name=document.createElement('div');
              name.style.cssText="color:#cfe;overflow:hidden;text-overflow:ellipsis;white-space:nowrap";
              name.textContent=file.replace(/\.mp3$/,'');
              const btns=document.createElement('div'); btns.style.cssText="display:flex;gap:8px";
              const bPlay=document.createElement('button'); bPlay.className='btn'; bPlay.textContent='‚ñ∂ Reproducir';
              bPlay.addEventListener('click', ()=> playSfx(`audio/${key}/${encodeURIComponent(file)}`));
              const bStop=document.createElement('button'); bStop.className='btn alt'; bStop.textContent='‚èπ Parar';
              bStop.addEventListener('click', stopLast);
              btns.append(bPlay,bStop); row.append(name,btns); body.appendChild(row);
            });
          }
          det.append(sum,body); into.appendChild(det);
        });
      }
      build(sfxCats);
      build(sfxCatsFb);
    })
    .catch(()=>{ err.style.display='block'; errFb.style.display='block'; });
})();
</script>
</body>
</html>